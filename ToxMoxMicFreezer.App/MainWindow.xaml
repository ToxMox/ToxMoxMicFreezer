<!-- SPDX-License-Identifier: Apache-2.0 -->
<!-- Copyright (c) 2025 CrunchFocus LLC -->
<Window x:Class="ToxMoxMicFreezer.App.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:local="clr-namespace:ToxMoxMicFreezer.App"
        xmlns:ui="http://schemas.lepo.co/wpfui/2022/xaml"
        xmlns:uc="clr-namespace:ToxMoxMicFreezer.App.UserControls"
        xmlns:converters="clr-namespace:ToxMoxMicFreezer.App.Converters"
        mc:Ignorable="d"
        Title="ToxMox's Mic Freezer+" Height="740" Width="1000"
        Closing="Window_Closing"
        StateChanged="Window_StateChanged"
        SizeChanged="Window_SizeChanged"
        LocationChanged="Window_LocationChanged"
        Background="{DynamicResource ApplicationBackgroundBrush}"
        WindowStyle="None"
        WindowStartupLocation="CenterScreen"
        AllowsTransparency="True"
        MinWidth="960" 
        MinHeight="620">

    <WindowChrome.WindowChrome>
        <WindowChrome CaptionHeight="0"
                      ResizeBorderThickness="0"
                      GlassFrameThickness="0"
                      CornerRadius="0"
                      UseAeroCaptionButtons="False"/>
    </WindowChrome.WindowChrome>

    <Window.Resources>
        <converters:VolumeToZeroConverter x:Key="VolumeToZeroConverter"/>
        <converters:PercentageToWidthMultiConverter x:Key="PercentageToWidthMultiConverter"/>
        <converters:VolumeBarColorConverter x:Key="VolumeBarColorConverter"/>
        
        <Style x:Key="DataGridStyle" TargetType="DataGrid">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="BorderBrush" Value="Transparent"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Foreground" Value="{DynamicResource TextFillColorPrimaryBrush}"/>
            <Setter Property="AlternatingRowBackground" Value="{DynamicResource ControlFillColorSecondaryBrush}"/>
            <Setter Property="RowBackground" Value="{DynamicResource ControlFillColorDefaultBrush}"/>
            <Setter Property="HorizontalGridLinesBrush" Value="Transparent"/>
            <Setter Property="VerticalGridLinesBrush" Value="Transparent"/>
        </Style>
        
        <Style x:Key="DataGridColumnHeaderStyle" TargetType="DataGridColumnHeader">
            <Setter Property="Background" Value="{DynamicResource ControlFillColorTertiaryBrush}"/>
            <Setter Property="Foreground" Value="{DynamicResource TextFillColorPrimaryBrush}"/>
            <Setter Property="Padding" Value="8,4,8,4"/>
            <Setter Property="BorderBrush" Value="Transparent"/>
            <Setter Property="BorderThickness" Value="0"/>
        </Style>
        
        <Style x:Key="DataGridCellStyle" TargetType="DataGridCell">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="BorderBrush" Value="Transparent"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Padding" Value="8,2"/>
        </Style>

        <!-- Snowflake Button Style -->
        <Style x:Key="SnowflakeButtonStyle" TargetType="CheckBox">
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="CheckBox">
                        <Border x:Name="SnowflakeBorder" 
                                Width="28" Height="28" 
                                CornerRadius="14" 
                                Background="#E0E0E0" 
                                BorderBrush="#B0B0B0" 
                                BorderThickness="1"
                                Margin="2">
                            <TextBlock x:Name="SnowflakeIcon" 
                                      Text="&#xf2dc;" 
                                      FontFamily="{StaticResource FontAwesome}"
                                      FontSize="16" 
                                      HorizontalAlignment="Center" 
                                      VerticalAlignment="Center"
                                      Foreground="#888888"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsChecked" Value="True">
                                <Setter TargetName="SnowflakeBorder" Property="Background" Value="#4A90E2"/>
                                <Setter TargetName="SnowflakeBorder" Property="BorderBrush" Value="#357ABD"/>
                                <Setter TargetName="SnowflakeIcon" Property="Foreground" Value="White"/>
                            </Trigger>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="SnowflakeBorder" Property="Background" Value="#F0F0F0"/>
                            </Trigger>
                            <MultiTrigger>
                                <MultiTrigger.Conditions>
                                    <Condition Property="IsMouseOver" Value="True"/>
                                    <Condition Property="IsChecked" Value="True"/>
                                </MultiTrigger.Conditions>
                                <Setter TargetName="SnowflakeBorder" Property="Background" Value="#5BA0F2"/>
                            </MultiTrigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <!-- Interactive Icon Style -->
        <Style x:Key="InteractiveIconStyle" TargetType="CheckBox">
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="CheckBox">
                        <Grid>
                            <TextBlock x:Name="IconText" 
                                      Text="&#xf2dc;" 
                                      FontFamily="{StaticResource FontAwesome}"
                                      FontSize="14" 
                                      HorizontalAlignment="Center" 
                                      VerticalAlignment="Center" 
                                      Foreground="#B0B0B0" 
                                      RenderTransformOrigin="0.5,0.5"
                                      Cursor="Hand">
                                <TextBlock.RenderTransform>
                                    <ScaleTransform ScaleX="1" ScaleY="1"/>
                                </TextBlock.RenderTransform>
                            </TextBlock>
                        </Grid>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsChecked" Value="True">
                                <Setter TargetName="IconText" Property="Foreground" Value="#4A90E2"/>
                                <Setter TargetName="IconText" Property="Effect">
                                    <Setter.Value>
                                        <DropShadowEffect Color="#4A90E2" ShadowDepth="0" BlurRadius="6" Opacity="0.4"/>
                                    </Setter.Value>
                                </Setter>
                            </Trigger>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="IconText" Property="RenderTransform">
                                    <Setter.Value>
                                        <ScaleTransform ScaleX="1.1" ScaleY="1.1"/>
                                    </Setter.Value>
                                </Setter>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <!-- Traditional Checkbox Style -->
        <Style x:Key="TraditionalCheckboxStyle" TargetType="CheckBox">
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="CheckBox">
                        <Grid>
                            <Border x:Name="CheckboxBorder" 
                                    Width="16" Height="16" 
                                    Background="White" 
                                    BorderBrush="#B0B0B0" 
                                    BorderThickness="1">
                                <TextBlock x:Name="CheckMark" 
                                          Text="&#xf00c;" 
                                          FontFamily="{StaticResource FontAwesome}"
                                          FontSize="12" 
                                          HorizontalAlignment="Center" 
                                          VerticalAlignment="Center"
                                          Foreground="#4A90E2"
                                          Visibility="Collapsed"/>
                            </Border>
                        </Grid>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsChecked" Value="True">
                                <Setter TargetName="CheckMark" Property="Visibility" Value="Visible"/>
                                <Setter TargetName="CheckboxBorder" Property="BorderBrush" Value="#4A90E2"/>
                            </Trigger>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="CheckboxBorder" Property="BorderBrush" Value="#357ABD"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <!-- Custom Toggle Style using native CheckBox -->
        <Style x:Key="ToggleButtonStyle" TargetType="CheckBox">
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="CheckBox">
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>
                            <Border x:Name="ToggleSwitchBackground" Width="40" Height="20" 
                                    CornerRadius="10" Background="#4A4A4A" BorderBrush="#6A6A6A" BorderThickness="1" Margin="0,0,5,0">
                                <Ellipse x:Name="ToggleSwitchKnob" Width="16" Height="16" 
                                         Fill="#CCCCCC" HorizontalAlignment="Left" Margin="2,0,0,0" 
                                         VerticalAlignment="Center"/>
                            </Border>
                            <ContentPresenter Grid.Column="1" VerticalAlignment="Center" 
                                              HorizontalAlignment="Left" Content="{TemplateBinding Content}"/>
                        </Grid>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsChecked" Value="True">
                                <Setter TargetName="ToggleSwitchBackground" Property="Background" Value="#9E2154"/>
                                <Setter TargetName="ToggleSwitchKnob" Property="Fill" Value="White"/>
                                <Setter TargetName="ToggleSwitchKnob" Property="HorizontalAlignment" Value="Right"/>
                                <Setter TargetName="ToggleSwitchKnob" Property="Margin" Value="0,0,2,0"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <!-- Mute Button Style -->
        <Style x:Key="MuteButtonStyle" TargetType="CheckBox">
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="CheckBox">
                        <Grid>
                            <TextBlock x:Name="IconText" 
                                      Text="{Binding MuteIconGlyph}" 
                                      FontFamily="{StaticResource FontAwesome}"
                                      FontSize="14" 
                                      HorizontalAlignment="Center" 
                                      VerticalAlignment="Center" 
                                      Foreground="#B0B0B0" 
                                      RenderTransformOrigin="0.5,0.5"
                                      Cursor="Hand">
                                <TextBlock.RenderTransform>
                                    <ScaleTransform ScaleX="1" ScaleY="1"/>
                                </TextBlock.RenderTransform>
                            </TextBlock>
                        </Grid>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsChecked" Value="True">
                                <Setter TargetName="IconText" Property="Foreground" Value="#DC3545"/>
                                <Setter TargetName="IconText" Property="Effect">
                                    <Setter.Value>
                                        <DropShadowEffect Color="#DC3545" ShadowDepth="0" BlurRadius="6" Opacity="0.4"/>
                                    </Setter.Value>
                                </Setter>
                            </Trigger>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="IconText" Property="RenderTransform">
                                    <Setter.Value>
                                        <ScaleTransform ScaleX="1.1" ScaleY="1.1"/>
                                    </Setter.Value>
                                </Setter>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
    </Window.Resources>

    <Border x:Name="MainBorder" BorderThickness="1" BorderBrush="{DynamicResource ControlElevationBorderBrush}" CornerRadius="8" MouseLeftButtonDown="Border_MouseLeftButtonDown">
        <Grid>
            <!-- Window resize elements with improved positioning and sizing -->
            <Rectangle x:Name="ResizeLeft" Width="8" HorizontalAlignment="Left" VerticalAlignment="Stretch" Cursor="SizeWE" Fill="Transparent" PreviewMouseLeftButtonDown="ResizeSide_PreviewMouseLeftButtonDown" Tag="Left" Margin="0,8,0,8" />
            <Rectangle x:Name="ResizeRight" Width="8" HorizontalAlignment="Right" VerticalAlignment="Stretch" Cursor="SizeWE" Fill="Transparent" PreviewMouseLeftButtonDown="ResizeSide_PreviewMouseLeftButtonDown" Tag="Right" Margin="0,8,0,8" />
            <Rectangle x:Name="ResizeTop" Height="8" VerticalAlignment="Top" HorizontalAlignment="Stretch" Cursor="SizeNS" Fill="Transparent" PreviewMouseLeftButtonDown="ResizeSide_PreviewMouseLeftButtonDown" Tag="Top" Margin="8,0,8,0" />
            <Rectangle x:Name="ResizeBottom" Height="8" VerticalAlignment="Bottom" HorizontalAlignment="Stretch" Cursor="SizeNS" Fill="Transparent" PreviewMouseLeftButtonDown="ResizeSide_PreviewMouseLeftButtonDown" Tag="Bottom" Margin="8,0,8,0" />
            
            <!-- Corner elements for diagonal resize with improved size -->
            <Rectangle x:Name="ResizeTopLeft" Width="12" Height="12" HorizontalAlignment="Left" VerticalAlignment="Top" Cursor="SizeNWSE" Fill="Transparent" PreviewMouseLeftButtonDown="ResizeSide_PreviewMouseLeftButtonDown" Tag="TopLeft" />
            <Rectangle x:Name="ResizeTopRight" Width="12" Height="12" HorizontalAlignment="Right" VerticalAlignment="Top" Cursor="SizeNESW" Fill="Transparent" PreviewMouseLeftButtonDown="ResizeSide_PreviewMouseLeftButtonDown" Tag="TopRight" />
            <Rectangle x:Name="ResizeBottomLeft" Width="12" Height="12" HorizontalAlignment="Left" VerticalAlignment="Bottom" Cursor="SizeNESW" Fill="Transparent" PreviewMouseLeftButtonDown="ResizeSide_PreviewMouseLeftButtonDown" Tag="BottomLeft" />
            <Rectangle x:Name="ResizeBottomRight" Width="12" Height="12" HorizontalAlignment="Right" VerticalAlignment="Bottom" Cursor="SizeNWSE" Fill="Transparent" PreviewMouseLeftButtonDown="ResizeSide_PreviewMouseLeftButtonDown" Tag="BottomRight" />
            
            <!-- Absolutely positioned app icon and title -->
            <Border Grid.RowSpan="6"
                    Panel.ZIndex="10"
                    Width="32" 
                    Height="32" 
                    Margin="8,6,0,0"
                    VerticalAlignment="Top"
                    HorizontalAlignment="Left">
                <Border.Background>
                    <ImageBrush x:Name="AppIconBrush" Stretch="Uniform" />
                </Border.Background>
            </Border>

            <TextBlock Grid.RowSpan="6"
                      Panel.ZIndex="10"
                      Text="ToxMox's Mic Freezer+" 
                      Foreground="{DynamicResource TextFillColorPrimaryBrush}"
                      VerticalAlignment="Top"
                      HorizontalAlignment="Left"
                      Margin="48,9,0,0"
                      FontSize="16"
                      FontWeight="Bold"/>

            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="32"/>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*" MinHeight="90"/>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="200" MinHeight="100" MaxHeight="400"/>
                </Grid.RowDefinitions>

                <!-- Custom Title Bar -->
                <Grid Grid.Row="0" Background="Transparent" MouseLeftButtonDown="TitleBar_MouseLeftButtonDown">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>

                    <StackPanel Grid.Column="1" 
                              Orientation="Horizontal" 
                              HorizontalAlignment="Right">
                        <Button
                            x:Name="PauseButton"
                            Width="46"
                            Height="32"
                            Click="PauseButton_Click"
                            ToolTip="Pause volume monitoring">
                            <Button.ContextMenu>
                                <ContextMenu>
                                    <MenuItem Header="5 minutes" Click="Pause5Min_Click"/>
                                    <MenuItem Header="15 minutes" Click="Pause15Min_Click"/>
                                    <MenuItem Header="30 minutes" Click="Pause30Min_Click"/>
                                    <MenuItem Header="1 hour" Click="Pause1Hour_Click"/>
                                    <MenuItem Header="Until manually resumed" Click="PauseIndefinite_Click"/>
                                </ContextMenu>
                            </Button.ContextMenu>
                            <Button.Content>
                                <TextBlock x:Name="PauseIcon" Text="&#xf04c;" FontFamily="{StaticResource FontAwesome}" FontSize="16" VerticalAlignment="Center" HorizontalAlignment="Center" />
                            </Button.Content>
                        </Button>
                        <Button
                            x:Name="DebugRefreshButton"
                            Width="46"
                            Height="32"
                            Click="DebugRefreshButton_Click"
                            ToolTip="Debug: Force device re-enumeration"
                            Visibility="Collapsed">
                            <Button.Content>
                                <TextBlock Text="&#xf021;" FontFamily="{StaticResource FontAwesome}" FontSize="16" VerticalAlignment="Center" HorizontalAlignment="Center" />
                            </Button.Content>
                        </Button>
                        <Button
                            x:Name="HelpButton"
                            Width="46"
                            Height="32"
                            Click="HelpButton_Click"
                            ToolTip="Help">
                            <Button.Content>
                                <TextBlock Text="&#xf059;" FontFamily="{StaticResource FontAwesome}" FontSize="16" VerticalAlignment="Center" HorizontalAlignment="Center" />
                            </Button.Content>
                        </Button>
                        <Button
                            x:Name="SettingsButton"
                            Width="46"
                            Height="32"
                            Click="SettingsButton_Click"
                            ToolTip="Settings">
                            <Button.Content>
                                <TextBlock Text="&#xf013;" FontFamily="{StaticResource FontAwesome}" FontSize="16" VerticalAlignment="Center" HorizontalAlignment="Center" />
                            </Button.Content>
                        </Button>
                        <Button
                            Width="46"
                            Height="32"
                            Click="MinimizeButton_Click">
                            <Button.Content>
                                <TextBlock Text="&#xf2d1;" FontFamily="{StaticResource FontAwesome}" VerticalAlignment="Center" HorizontalAlignment="Center" />
                            </Button.Content>
                        </Button>
                        <Button
                            x:Name="MaximizeButton"
                            Width="46"
                            Height="32"
                            Click="MaximizeButton_Click">
                            <Button.Content>
                                <TextBlock x:Name="MaximizeIcon" Text="&#xf2d0;" FontFamily="{StaticResource FontAwesome}" VerticalAlignment="Center" HorizontalAlignment="Center" FontSize="16" />
                            </Button.Content>
                        </Button>
                        <Button
                            Width="46"
                            Height="32"
                            Click="CloseButton_Click">
                            <Button.Content>
                                <TextBlock Text="&#xf00d;" FontFamily="{StaticResource FontAwesome}" VerticalAlignment="Center" HorizontalAlignment="Center" />
                            </Button.Content>
                        </Button>
                    </StackPanel>
                </Grid>

                <!-- Status Banners Container -->
                <StackPanel Grid.Row="1">
                    <!-- Pause Status Banner -->
                    <Border x:Name="PauseStatusBanner" 
                            Background="#FF6B47" 
                            Visibility="Collapsed"
                            Height="36">
                        <Grid Margin="18,0">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>
                            <StackPanel x:Name="PauseStatusText" 
                                       Grid.Column="0"
                                       Orientation="Horizontal"
                                       VerticalAlignment="Center">
                                <TextBlock Text="&#xf2dc;" FontFamily="{StaticResource FontAwesome}" Foreground="White" FontSize="14" VerticalAlignment="Center" Margin="0,0,8,0"/>
                                <TextBlock x:Name="PauseStatusTextBlock" Text="Volume monitoring paused" Foreground="White" VerticalAlignment="Center"/>
                            </StackPanel>
                            <StackPanel Grid.Column="1" Orientation="Horizontal">
                                <Button Click="ResumeButton_Click" Margin="0,0,5,0">
                                    <StackPanel Orientation="Horizontal">
                                        <TextBlock Text="&#xf04b;" FontFamily="{StaticResource FontAwesome}" FontSize="12" VerticalAlignment="Center" Margin="0,0,4,0"/>
                                        <TextBlock Text="Resume" VerticalAlignment="Center"/>
                                    </StackPanel>
                                </Button>
                                <Button Content="+5min" Click="ExtendPause_Click"/>
                            </StackPanel>
                        </Grid>
                    </Border>

                    <!-- Notification Mute Status Banner -->
                    <Border x:Name="NotificationMuteStatusBanner" 
                            Background="#7B47FF" 
                            Visibility="Collapsed"
                            Height="36">
                        <Grid Margin="18,0">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>
                            <StackPanel x:Name="NotificationMuteStatusText" 
                                       Grid.Column="0"
                                       Orientation="Horizontal"
                                       VerticalAlignment="Center">
                                <TextBlock Text="&#xf0f3;" FontFamily="{StaticResource FontAwesome}" Foreground="White" FontSize="14" VerticalAlignment="Center" Margin="0,0,8,0"/>
                                <TextBlock x:Name="NotificationMuteStatusTextBlock" Text="Popup notifications muted" Foreground="White" VerticalAlignment="Center"/>
                            </StackPanel>
                            <StackPanel Grid.Column="1" Orientation="Horizontal">
                                <Button Click="EnableNotificationsButton_Click" Margin="0,0,5,0">
                                    <StackPanel Orientation="Horizontal">
                                        <TextBlock Text="&#xf0f3;" FontFamily="{StaticResource FontAwesome}" FontSize="12" VerticalAlignment="Center" Margin="0,0,4,0"/>
                                        <TextBlock Text="Enable" VerticalAlignment="Center"/>
                                    </StackPanel>
                                </Button>
                            </StackPanel>
                        </Grid>
                    </Border>
                </StackPanel>

                <!-- TabView (when playback devices enabled) -->
                <TabControl Grid.Row="2" 
                           Margin="10,0,10,10" 
                           x:Name="DeviceTabView"
                           SelectionChanged="DeviceTabView_SelectionChanged">
                    <TabControl.Style>
                        <Style TargetType="TabControl">
                            <Setter Property="Background" Value="Transparent"/>
                            <Setter Property="BorderThickness" Value="0"/>
                        </Style>
                    </TabControl.Style>
                    <TabControl.Resources>
                        <Style TargetType="TabItem">
                            <Setter Property="Template">
                                <Setter.Value>
                                    <ControlTemplate TargetType="TabItem">
                                        <Grid>
                                            <Border Name="Border" 
                                                   Background="{DynamicResource ControlFillColorTertiaryBrush}"
                                                   BorderBrush="{DynamicResource ControlElevationBorderBrush}"
                                                   BorderThickness="1"
                                                   CornerRadius="4,4,0,0"
                                                   Margin="0,0,2,0"
                                                   Padding="12,6,12,8">
                                                <ContentPresenter x:Name="ContentSite"
                                                                VerticalAlignment="Center"
                                                                HorizontalAlignment="Center"
                                                                ContentSource="Header"
                                                                RecognizesAccessKey="True"/>
                                            </Border>
                                            <!-- Accent indicator line -->
                                            <Rectangle x:Name="AccentLine" 
                                                      Height="3" 
                                                      VerticalAlignment="Bottom"
                                                      Fill="{DynamicResource SystemAccentColorPrimaryBrush}"
                                                      Visibility="Collapsed"
                                                      Margin="1,0,1,1"/>
                                        </Grid>
                                        <ControlTemplate.Triggers>
                                            <Trigger Property="IsSelected" Value="True">
                                                <Setter TargetName="Border" Property="Background" Value="{DynamicResource CardBackgroundFillColorDefaultBrush}"/>
                                                <Setter TargetName="Border" Property="BorderThickness" Value="1,1,1,0"/>
                                                <Setter TargetName="AccentLine" Property="Visibility" Value="Visible"/>
                                                <Setter TargetName="ContentSite" Property="TextElement.FontWeight" Value="Bold"/>
                                            </Trigger>
                                            <Trigger Property="IsMouseOver" Value="True">
                                                <Setter TargetName="Border" Property="Background" Value="{DynamicResource CardBackgroundFillColorSecondaryBrush}"/>
                                            </Trigger>
                                        </ControlTemplate.Triggers>
                                    </ControlTemplate>
                                </Setter.Value>
                            </Setter>
                            <Setter Property="Foreground" Value="{DynamicResource TextFillColorPrimaryBrush}"/>
                            <Setter Property="FontSize" Value="16"/>
                            <Setter Property="FontWeight" Value="SemiBold"/>
                        </Style>
                    </TabControl.Resources>
                    
                    <!-- Recording Devices Tab -->
                    <TabItem>
                        <TabItem.Header>
                            <TextBlock>
                                <Run Text="&#xf130;" FontFamily="{StaticResource FontAwesome}" FontSize="16" Foreground="{DynamicResource TextFillColorPrimaryBrush}"/>
                                <Run Text=" Recording Devices" Foreground="{DynamicResource TextFillColorPrimaryBrush}"/>
                                <Run Text=" (" Foreground="#FF69B4"/>
                                <Run x:Name="RecordingMonitoringText" Text="Monitoring 0 of 0" Foreground="#E6E6E6"/>
                                <Run Text=")" Foreground="#FF69B4"/>
                            </TextBlock>
                        </TabItem.Header>
                        
                        <ScrollViewer VerticalScrollBarVisibility="Auto"
                                     HorizontalScrollBarVisibility="Disabled"
                                     ScrollChanged="ScrollViewer_ScrollChanged"
                                     PreviewMouseWheel="MainScrollViewer_PreviewMouseWheel">
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>
                                
                                <uc:DeviceVolumeBarUserControl Grid.Column="0"
                                                               DeviceCollection="{Binding RecordingDevicesLeft}"
                                                               GridMargin="0,0,5,0"/>

                                <uc:DeviceVolumeBarUserControl Grid.Column="1"
                                                               DeviceCollection="{Binding RecordingDevicesRight}"
                                                               GridMargin="5,0,0,0"/>
                            </Grid>
                        </ScrollViewer>
                    </TabItem>
                    
                    <!-- Playback Devices Tab -->
                    <TabItem>
                        <TabItem.Header>
                            <TextBlock>
                                <Run Text="&#xf028;" FontFamily="{StaticResource FontAwesome}" FontSize="16" Foreground="{DynamicResource TextFillColorPrimaryBrush}"/>
                                <Run Text=" Playback Devices" Foreground="{DynamicResource TextFillColorPrimaryBrush}"/>
                                <Run Text=" (" Foreground="#FF69B4"/>
                                <Run x:Name="PlaybackMonitoringText" Text="Monitoring 0 of 0" Foreground="#E6E6E6"/>
                                <Run Text=")" Foreground="#FF69B4"/>
                            </TextBlock>
                        </TabItem.Header>
                        
                        <ScrollViewer VerticalScrollBarVisibility="Auto"
                                     HorizontalScrollBarVisibility="Disabled"
                                     ScrollChanged="ScrollViewer_ScrollChanged"
                                     PreviewMouseWheel="MainScrollViewer_PreviewMouseWheel">
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>
                                
                                <uc:DeviceVolumeBarUserControl Grid.Column="0"
                                                               DeviceCollection="{Binding PlaybackDevicesLeft}"
                                                               GridMargin="0,0,5,0"/>

                                <uc:DeviceVolumeBarUserControl Grid.Column="1"
                                                               DeviceCollection="{Binding PlaybackDevicesRight}"
                                                               GridMargin="5,0,0,0"/>
                            </Grid>
                        </ScrollViewer>
                    </TabItem>
                    
                    <!-- Favorites Tab -->
                    <TabItem>
                        <TabItem.Header>
                            <TextBlock>
                                <Run Text="&#xf005;" FontFamily="{StaticResource FontAwesome}" FontSize="16" Foreground="{DynamicResource TextFillColorPrimaryBrush}"/>
                                <Run Text=" Favorites" Foreground="{DynamicResource TextFillColorPrimaryBrush}"/>
                                <Run Text=" (" Foreground="#FFD700"/>
                                <Run x:Name="FavoritesCountText" Text="0" Foreground="#E6E6E6"/>
                                <Run Text=")" Foreground="#FFD700"/>
                            </TextBlock>
                        </TabItem.Header>
                        
                        <ScrollViewer VerticalScrollBarVisibility="Auto"
                                     HorizontalScrollBarVisibility="Disabled"
                                     ScrollChanged="ScrollViewer_ScrollChanged"
                                     PreviewMouseWheel="MainScrollViewer_PreviewMouseWheel">
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>
                                
                                <uc:DeviceVolumeBarUserControl Grid.Column="0"
                                                               DeviceCollection="{Binding FavoriteDevicesLeft}"
                                                               GridMargin="0,0,5,0"
                                                               IsFavoritesTab="True"
                                                               FavoriteColumn="Left"/>

                                <uc:DeviceVolumeBarUserControl Grid.Column="1"
                                                               DeviceCollection="{Binding FavoriteDevicesRight}"
                                                               GridMargin="5,0,0,0"
                                                               IsFavoritesTab="True"
                                                               FavoriteColumn="Right"/>
                            </Grid>
                        </ScrollViewer>
                    </TabItem>
                </TabControl>

                <!-- GridSplitter for resizing log panel -->
                <GridSplitter Grid.Row="3" 
                             Height="8" 
                             HorizontalAlignment="Stretch" 
                             VerticalAlignment="Center"
                             Background="{DynamicResource ControlStrokeColorDefaultBrush}"
                             BorderBrush="{DynamicResource ControlElevationBorderBrush}"
                             BorderThickness="0,1,0,1"
                             Cursor="SizeNS"
                             Margin="10,0,10,0"
                             DragCompleted="LogPanelSplitter_DragCompleted">
                    <GridSplitter.Style>
                        <Style TargetType="GridSplitter">
                            <Setter Property="Template">
                                <Setter.Value>
                                    <ControlTemplate TargetType="GridSplitter">
                                        <Border Background="{TemplateBinding Background}"
                                               BorderBrush="{TemplateBinding BorderBrush}"
                                               BorderThickness="{TemplateBinding BorderThickness}">
                                            <Rectangle Width="50" Height="3" 
                                                     HorizontalAlignment="Center" 
                                                     VerticalAlignment="Center"
                                                     Fill="{DynamicResource TextFillColorSecondaryBrush}"
                                                     RadiusX="1.5" RadiusY="1.5"/>
                                        </Border>
                                        <ControlTemplate.Triggers>
                                            <Trigger Property="IsMouseOver" Value="True">
                                                <Setter Property="Background" Value="{DynamicResource ControlStrokeColorSecondaryBrush}"/>
                                            </Trigger>
                                        </ControlTemplate.Triggers>
                                    </ControlTemplate>
                                </Setter.Value>
                            </Setter>
                        </Style>
                    </GridSplitter.Style>
                </GridSplitter>

                <!-- Enhanced Log Panel with Smart Auto-Scroll -->
                <uc:LogPanelUserControl x:Name="LogPanel" Grid.Row="4" Margin="10,0,10,10"/>
                
                <!-- Help Popup -->
                <Popup x:Name="HelpPopup" 
                      Placement="Bottom" 
                      PlacementTarget="{Binding ElementName=HelpButton}"
                      StaysOpen="False"
                      AllowsTransparency="True">
                    <uc:HelpPanelUserControl x:Name="HelpPanel"/>
                </Popup>
                
                <!-- Settings Popup -->
                <Popup x:Name="SettingsPopup" 
                      Placement="Right" 
                      PlacementTarget="{Binding ElementName=SettingsButton}"
                      StaysOpen="False"
                      AllowsTransparency="True">
                    <uc:SettingsPanelUserControl x:Name="SettingsPanel"/>
                </Popup>

                <!-- Window resize grip -->
                <Thumb x:Name="ResizeGrip" Grid.Row="4" HorizontalAlignment="Right" VerticalAlignment="Bottom"
                       Width="16" Height="16" Margin="0,0,5,5" Cursor="SizeNWSE" DragDelta="ResizeGrip_DragDelta"
                       Opacity="0.5">
                    <Thumb.Template>
                        <ControlTemplate>
                            <Path Data="M 0,16 L 16,0 16,16 Z" Fill="#AAA"/>
                        </ControlTemplate>
                    </Thumb.Template>
                </Thumb>
            </Grid>
            
            <!-- Device Reset Overlay - spans entire window with highest ZIndex -->
            <uc:DeviceResetOverlayUserControl x:Name="DeviceResetOverlay" 
                                             Grid.RowSpan="5"
                                             Panel.ZIndex="1000"
                                             Visibility="Collapsed"/>
        </Grid>
    </Border>
</Window>
